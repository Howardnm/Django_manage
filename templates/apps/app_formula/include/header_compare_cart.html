<!-- 配方对比购物车 (Header Dropdown) -->
<div class="nav-item dropdown d-none d-md-flex me-3">
    <a href="#" class="nav-link px-0" data-bs-toggle="dropdown" tabindex="-1" aria-label="Show compare cart">
        <i class="ti ti-columns icon"></i>
        <span class="badge bg-red text-white" id="header-compare-count" style="display: none;">0</span>
    </a>
    <div class="dropdown-menu dropdown-menu-arrow dropdown-menu-end dropdown-menu-card" style="width: 350px;">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">对比清单</h3>
                <div class="card-actions">
                    <a href="#" onclick="clearCompareCart(); return false;" class="text-muted small">清空</a>
                </div>
            </div>
            
            <div class="list-group list-group-flush list-group-hoverable" id="header-compare-items" style="max-height: 400px; overflow-y: auto;">
                <!-- 动态插入对比项 -->
                <div class="list-group-item text-center text-muted py-3 empty-cart-msg">
                    暂无对比项目
                </div>
            </div>
            
            <div class="card-footer">
                <div class="d-flex">
                    <a href="{% url 'formula_compare' %}" class="btn btn-yellow w-100 me-2" id="btn-start-compare">
                        开始对比
                    </a>
                    <a href="{% url 'formula_chart_compare' %}" class="btn btn-primary w-100" id="btn-start-chart-compare">
                        图表对比
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function() {
        refreshCompareCart();
    });

    // 刷新 Header 购物车
    function refreshCompareCart() {
        // 尝试获取 CSRF Token
        let csrfToken = '{{ csrf_token }}';
        const csrfInput = document.querySelector('[name=csrfmiddlewaretoken]');
        if (csrfInput) {
            csrfToken = csrfInput.value;
        }

        fetch("{% url 'formula_compare_cart' %}")
            .then(response => response.json())
            .then(data => {
                const countBadge = document.getElementById('header-compare-count');
                const itemsContainer = document.getElementById('header-compare-items');
                const startBtn = document.getElementById('btn-start-compare');
                const startChartBtn = document.getElementById('btn-start-chart-compare');
                
                if (!countBadge || !itemsContainer) return;

                // 更新数量徽章
                if (data.count > 0) {
                    countBadge.textContent = data.count;
                    countBadge.style.display = 'block';
                    startBtn.classList.remove('disabled');
                    startChartBtn.classList.remove('disabled');
                } else {
                    countBadge.style.display = 'none';
                    startBtn.classList.add('disabled');
                    startChartBtn.classList.add('disabled');
                }

                // 更新列表内容
                itemsContainer.innerHTML = '';
                
                if (data.count > 0) {
                    // 分组数据
                    const formulas = data.items.filter(i => i.type === 'formula');
                    const materials = data.items.filter(i => i.type === 'material');
                    const rawMaterials = data.items.filter(i => i.type === 'raw_material');

                    // 辅助函数：生成列表项 HTML
                    const renderItem = (item, badgeClass, badgeText, removeType, detailUrl) => `
                        <div class="list-group-item d-flex align-items-center justify-content-between p-2">
                            <div class="d-flex align-items-center text-truncate me-2" style="max-width: 280px;">
                                <span class="badge ${badgeClass} me-2" style="min-width: 50px;">${badgeText}</span>
                                <div class="text-truncate">
                                    <a href="${detailUrl}" class="fw-bold small text-truncate text-reset d-block" title="${item.name || item.code}">${item.name || item.code}</a>
                                    <div class="text-muted small text-truncate" title="${item.desc || '未命名'}">${item.desc || '未命名'}</div>
                                </div>
                            </div>
                            <a href="#" onclick="removeFromCompare(${item.id}, '${removeType}'); return false;" class="text-muted ms-2" title="移除">
                                <i class="ti ti-x"></i>
                            </a>
                        </div>
                    `;

                    // 1. 渲染配方
                    if (formulas.length > 0) {
                        itemsContainer.insertAdjacentHTML('beforeend', '<div class="list-group-header sticky-top bg-white">配方 (' + formulas.length + ')</div>');
                        formulas.forEach(item => {
                            const url = "{% url 'formula_detail' 0 %}".replace('0', item.id);
                            itemsContainer.insertAdjacentHTML('beforeend', renderItem(item, 'bg-purple-lt', '配方', 'formula', url));
                        });
                    }

                    // 2. 渲染材料
                    if (materials.length > 0) {
                        itemsContainer.insertAdjacentHTML('beforeend', '<div class="list-group-header sticky-top bg-white">材料 (' + materials.length + ')</div>');
                        materials.forEach(item => {
                            const url = "{% url 'repo_material_detail' 0 %}".replace('0', item.id);
                            itemsContainer.insertAdjacentHTML('beforeend', renderItem(item, 'bg-blue-lt', '材料', 'material', url));
                        });
                    }

                    // 3. 渲染原材料
                    if (rawMaterials.length > 0) {
                        itemsContainer.insertAdjacentHTML('beforeend', '<div class="list-group-header sticky-top bg-white">原材料 (' + rawMaterials.length + ')</div>');
                        rawMaterials.forEach(item => {
                            const url = "{% url 'raw_material_detail' 0 %}".replace('0', item.id);
                            itemsContainer.insertAdjacentHTML('beforeend', renderItem(item, 'bg-orange-lt', '原材料', 'raw_material', url));
                        });
                    }
                    
                    // 同步更新页面上的复选框状态
                    const checkboxes = document.querySelectorAll('.compare-checkbox');
                    checkboxes.forEach(cb => {
                        let cbType = cb.getAttribute('data-type');
                        // 简单的类型推断兜底
                        if (!cbType) {
                            if (window.location.pathname.includes('formula')) cbType = 'formula';
                            else if (window.location.pathname.includes('raw_material')) cbType = 'raw_material';
                            else if (window.location.pathname.includes('material')) cbType = 'material';
                        }
                        
                        if (cbType) {
                            const isChecked = data.items.some(i => i.id == cb.value && i.type === cbType);
                            cb.checked = isChecked;
                        }
                    });
                    
                } else {
                    itemsContainer.innerHTML = '<div class="list-group-item text-center text-muted py-3">暂无对比项目</div>';
                    // 清空复选框
                    document.querySelectorAll('.compare-checkbox').forEach(cb => {
                        cb.checked = false;
                    });
                }
            })
            .catch(error => console.error('Error refreshing compare cart:', error));
    }

    // 移除单个
    function removeFromCompare(id, type) {
        const formData = new FormData();
        formData.append('action', 'remove');
        formData.append('id', id);
        formData.append('type', type);
        
        // 动态获取 CSRF Token
        let csrfToken = '{{ csrf_token }}';
        const csrfInput = document.querySelector('[name=csrfmiddlewaretoken]');
        if (csrfInput) {
            csrfToken = csrfInput.value;
        }
        formData.append('csrfmiddlewaretoken', csrfToken);
        
        fetch("{% url 'formula_compare_cart' %}", {
            method: 'POST',
            body: formData
        }).then(() => refreshCompareCart());
    }

    // 清空
    function clearCompareCart() {
        const formData = new FormData();
        formData.append('action', 'clear');
        
        let csrfToken = '{{ csrf_token }}';
        const csrfInput = document.querySelector('[name=csrfmiddlewaretoken]');
        if (csrfInput) {
            csrfToken = csrfInput.value;
        }
        formData.append('csrfmiddlewaretoken', csrfToken);
        
        fetch("{% url 'formula_compare_cart' %}", {
            method: 'POST',
            body: formData
        }).then(() => refreshCompareCart());
    }
</script>