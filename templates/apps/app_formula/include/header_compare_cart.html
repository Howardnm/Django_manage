<!-- 配方对比购物车 (Header Dropdown) -->
<div class="nav-item dropdown d-none d-md-flex me-3">
    <a href="#" class="nav-link px-0" data-bs-toggle="dropdown" tabindex="-1" aria-label="Show compare cart">
        <i class="ti ti-columns icon"></i>
        <span class="badge bg-red text-white" id="header-compare-count" style="display: none;">0</span>
    </a>
    <div class="dropdown-menu dropdown-menu-arrow dropdown-menu-end dropdown-menu-card">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">对比清单</h3>
                <div class="card-actions">
                    <a href="#" onclick="clearCompareCart(); return false;" class="text-muted small">清空</a>
                </div>
            </div>
            <div class="list-group list-group-flush list-group-hoverable" id="header-compare-items" style="max-height: 300px; overflow-y: auto;">
                <!-- 动态插入对比项 -->
                <div class="list-group-item text-center text-muted py-3 empty-cart-msg">
                    暂无对比项目
                </div>
            </div>
            <div class="card-footer">
                <a href="{% url 'formula_compare' %}" class="btn btn-primary w-100" id="btn-start-compare">
                    开始对比
                </a>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function() {
        refreshCompareCart();
    });

    // 刷新 Header 购物车
    function refreshCompareCart() {
        fetch("{% url 'formula_compare_cart' %}")
            .then(response => response.json())
            .then(data => {
                const countBadge = document.getElementById('header-compare-count');
                const itemsContainer = document.getElementById('header-compare-items');
                const startBtn = document.getElementById('btn-start-compare');
                
                if (!countBadge || !itemsContainer) return;

                // 更新数量徽章
                if (data.count > 0) {
                    countBadge.textContent = data.count;
                    countBadge.style.display = 'block';
                    startBtn.classList.remove('disabled');
                } else {
                    countBadge.style.display = 'none';
                    startBtn.classList.add('disabled');
                }

                // 更新列表内容
                itemsContainer.innerHTML = '';
                
                if (data.count > 0) {
                    data.items.forEach(item => {
                        // 根据类型显示不同的图标或标签
                        let typeBadge = '';
                        let removeType = '';
                        if (item.type === 'material') {
                            typeBadge = '<span class="badge bg-blue-lt me-2">材料</span>';
                            removeType = 'material';
                        } else {
                            typeBadge = '<span class="badge bg-purple-lt me-2">配方</span>';
                            removeType = 'formula';
                        }

                        const itemHtml = `
                            <div class="list-group-item d-flex align-items-center justify-content-between p-2">
                                <div class="d-flex align-items-center text-truncate me-2" style="max-width: 220px;">
                                    ${typeBadge}
                                    <div class="text-truncate">
                                        <div class="fw-bold small">${item.name || item.code}</div>
                                        <div class="text-muted small text-truncate">${item.desc || '未命名'}</div>
                                    </div>
                                </div>
                                <a href="#" onclick="removeFromCompare(${item.id}, '${removeType}'); return false;" class="text-muted" title="移除">
                                    <i class="ti ti-x"></i>
                                </a>
                            </div>
                        `;
                        itemsContainer.insertAdjacentHTML('beforeend', itemHtml);
                    });
                    
                    // 【关键修复】同步更新页面上的复选框状态
                    // 必须区分当前页面是配方列表还是材料列表，以及复选框对应的类型
                    // 假设页面上有一个全局变量或特定类名来标识当前页面类型，或者我们只更新匹配类型的复选框
                    
                    // 1. 获取当前页面所有复选框
                    const checkboxes = document.querySelectorAll('.compare-checkbox');
                    
                    // 2. 遍历复选框，判断其应该被勾选还是取消
                    // 注意：这里我们无法直接知道复选框是配方还是材料，除非我们在 HTML 中加了 data-type 属性
                    // 建议在 list.html 中给 checkbox 添加 data-type="formula" 或 data-type="material"
                    
                    checkboxes.forEach(cb => {
                        // 尝试获取类型，如果没有 data-type，尝试根据页面 URL 或其他特征推断
                        // 但最稳妥的是后端渲染时已经处理了 checked 属性 (我们在 list.html 中已经做了)
                        // 这里的 JS 更新主要是为了在不刷新页面的情况下同步状态 (例如点击 Header 里的删除)
                        
                        let cbType = cb.getAttribute('data-type');
                        // 如果没有 data-type，尝试推断 (不推荐，容易出错)
                        if (!cbType) {
                            if (window.location.pathname.includes('formula')) cbType = 'formula';
                            else if (window.location.pathname.includes('material')) cbType = 'material';
                        }
                        
                        if (cbType) {
                            const isChecked = data.items.some(i => i.id == cb.value && i.type === cbType);
                            cb.checked = isChecked;
                        }
                    });
                    
                } else {
                    itemsContainer.innerHTML = '<div class="list-group-item text-center text-muted py-3">暂无对比项目</div>';
                    // 清空复选框
                    document.querySelectorAll('.compare-checkbox').forEach(cb => {
                        cb.checked = false;
                    });
                }
            })
            .catch(error => console.error('Error refreshing compare cart:', error));
    }

    // 移除单个
    function removeFromCompare(id, type) {
        const formData = new FormData();
        formData.append('action', 'remove');
        formData.append('id', id); // 统一参数名
        formData.append('type', type); // 必须传递类型
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || '{{ csrf_token }}';
        formData.append('csrfmiddlewaretoken', csrfToken);
        
        fetch("{% url 'formula_compare_cart' %}", {
            method: 'POST',
            body: formData
        }).then(() => refreshCompareCart());
    }

    // 清空
    function clearCompareCart() {
        const formData = new FormData();
        formData.append('action', 'clear');
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || '{{ csrf_token }}';
        formData.append('csrfmiddlewaretoken', csrfToken);
        
        fetch("{% url 'formula_compare_cart' %}", {
            method: 'POST',
            body: formData
        }).then(() => refreshCompareCart());
    }
</script>