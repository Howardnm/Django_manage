{% extends "base.html" %}
{% load static %}

{% block page_title %}{{ page_title }}{% endblock %}

{% block content %}
<div class="page-header d-print-none">
    <div class="container-xl">
        <div class="row g-2 align-items-center">
            <div class="col">
                <h2 class="page-title">{{ page_title }}</h2>
                <div class="text-muted mt-1">
                    {% if formulas %}
                        对比 {{ formulas|length }} 个配方
                    {% else %}
                        {{ message }}
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<div class="page-body">
    <div class="container-xl">
        {% if formulas %}
        <div class="row">
            <!-- 侧边栏：可选维度 -->
            <div class="col-lg-4">
                <div class="card mb-3">
                    <div class="card-header">
                        <h3 class="card-title">可选维度</h3>
                    </div>
                    <div class="card-body">
                        <h4 class="mb-2">原材料 (BOM)</h4>
                        <div id="raw-materials-list" class="dimension-list">
                            {% for rm in raw_materials %}
                            <div class="dimension-item" draggable="true" data-id="{{ rm.id }}" data-type="raw_material">
                                <i class="ti ti-flask icon-sm me-2"></i>
                                <span class="text-truncate">({{ rm.category.name }}) {{ rm.name }} {% if rm.model_name %}{{ rm.model_name }}{% endif %}</span>
                            </div>
                            {% empty %}
                            <div class="text-muted small">无可用原材料</div>
                            {% endfor %}
                        </div>
                        <hr class="my-3">
                        <h4 class="mb-2">物性指标</h4>
                        <div id="test-configs-list" class="dimension-list">
                            {% for tc in test_configs %}
                            <div class="dimension-item" draggable="true" data-id="{{ tc.id }}" data-type="test_config">
                                <i class="ti ti-ruler-measure icon-sm me-2"></i>
                                <span class="text-truncate">{{ tc.name }} <small class="text-muted">({{ tc.standard }}{% if tc.condition %} - {{ tc.condition }}{% endif %})</small></span>
                            </div>
                            {% empty %}
                            <div class="text-muted small">无可用数值型物性</div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- 主内容区：拖拽目标和图表 -->
            <div class="col-lg-8">
                <div class="card">
                    <div class="card-body">
                        <div class="row g-3 align-items-center mb-4">
                            <div class="col">
                                <div id="x-axis-dropzone" class="dropzone">
                                    <span class="dropzone-text">拖动指标到 X 轴</span>
                                </div>
                            </div>
                            <div class="col-auto">
                                <i class="ti ti-vs icon-lg"></i>
                            </div>
                            <div class="col">
                                <div id="y-axis-dropzone" class="dropzone multi-dropzone">
                                    <span class="dropzone-text">拖动一个或多个指标到 Y 轴</span>
                                </div>
                            </div>
                            <div class="col-auto">
                                <button id="reset-chart-btn" class="btn btn-secondary" title="清空"><i class="ti ti-x"></i></button>
                            </div>
                        </div>
                        
                        <div id="chart-container" style="min-height: 500px; display: flex; align-items: center; justify-content: center;">
                            <div class="empty">
                                <div class="empty-icon"><i class="ti ti-chart-line"></i></div>
                                <p class="empty-title">请从左侧拖动维度到 X 轴和 Y 轴</p>
                                <p class="empty-subtitle text-muted">
                                    将原材料或物性指标拖入上方框中，以生成关系图表。
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% else %}
        <div class="card">
            <div class="card-body">
                <div class="alert alert-warning" role="alert">
                    {{ message|default:"没有可用于图表对比的配方。" }}
                    <a href="{% url 'formula_list' %}" class="alert-link">返回配方列表</a>.
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<style>
    .dimension-list { max-height: 200px; overflow-y: auto; }
    .dimension-item { padding: 6px 10px; border: 1px solid #e5e7eb; border-radius: 4px; margin-bottom: 5px; cursor: grab; transition: background-color 0.2s, box-shadow 0.2s; display: flex; align-items: center; overflow: hidden; position: relative; }
    .dimension-item:hover { background-color: #f0f2f5; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    .dropzone { border: 2px dashed #adb5bd; border-radius: 4px; padding: 10px; text-align: center; transition: background-color 0.2s, border-color 0.2s; height: 100%; display: flex; align-items: center; justify-content: center; min-height: 70px; }
    .dropzone.multi-dropzone { flex-wrap: wrap; justify-content: flex-start; align-items: flex-start; gap: 5px; }
    .dropzone.drag-over { background-color: #e9f7ff; border-color: #467fcf; }
    .dropzone .dimension-item { cursor: default; box-shadow: none; padding-right: 25px; }
    .dropzone-text { color: #6c757d; }
    .remove-item-btn { position: absolute; top: 50%; right: 5px; transform: translateY(-50%); cursor: pointer; color: #999; display: none; font-size: 1.2em; line-height: 1; }
    .dropzone .dimension-item:hover .remove-item-btn { display: block; }
</style>
{% endblock %}

{% block extra_js %}
<script src="{% static 'highcharts/core-12.5.0/highcharts.js' %}"></script>
<script src="{% static 'highcharts/core-12.5.0/modules/exporting.js' %}"></script>
<script src="{% static 'highcharts/core-12.5.0/modules/accessibility.js' %}"></script>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const draggables = document.querySelectorAll('.dimension-item[draggable="true"]');
    const dropzones = document.querySelectorAll('.dropzone');
    let chart;

    if (draggables.length === 0) return;

    draggables.forEach(draggable => {
        draggable.addEventListener('dragstart', (e) => {
            const payload = JSON.stringify({
                id: e.target.closest('.dimension-item').dataset.id,
                type: e.target.closest('.dimension-item').dataset.type,
                html: e.target.closest('.dimension-item').innerHTML.trim()
            });
            e.dataTransfer.setData('application/json', payload);
            e.dataTransfer.effectAllowed = 'copy';
        });
    });

    dropzones.forEach(zone => {
        const preventDefaults = (e) => { e.preventDefault(); e.stopPropagation(); };
        zone.addEventListener('dragenter', (e) => { preventDefaults(e); zone.classList.add('drag-over'); }, false);
        zone.addEventListener('dragover', preventDefaults, false);
        zone.addEventListener('dragleave', (e) => { preventDefaults(e); zone.classList.remove('drag-over'); }, false);
        zone.addEventListener('drop', (e) => {
            preventDefaults(e);
            zone.classList.remove('drag-over');
            try {
                const payload = JSON.parse(e.dataTransfer.getData('application/json'));
                if (!payload.id || !payload.type) return;

                const newItem = document.createElement('div');
                newItem.className = 'dimension-item';
                newItem.dataset.id = payload.id;
                newItem.dataset.type = payload.type;
                newItem.innerHTML = payload.html + '<span class="remove-item-btn" style="font-size: 1.2em; line-height: 1;">&times;</span>';

                if (zone.id === 'y-axis-dropzone') {
                    const placeholder = zone.querySelector('.dropzone-text');
                    if (placeholder) placeholder.style.display = 'none';
                    zone.appendChild(newItem);
                } else {
                    zone.innerHTML = '';
                    zone.appendChild(newItem);
                }
                
                fetchChartData();
            } catch (err) { console.error("Drop Error:", err); }
        }, false);
    });

    document.querySelector('body').addEventListener('click', function(e) {
        if (e.target.classList.contains('remove-item-btn')) {
            const item = e.target.parentElement;
            const zone = item.parentElement;
            item.remove();
            if (zone.id === 'y-axis-dropzone' && zone.children.length === 0) {
                zone.innerHTML = '<span class="dropzone-text">拖动一个或多个指标到 Y 轴</span>';
            }
            fetchChartData();
        }
    });

    document.getElementById('reset-chart-btn').addEventListener('click', () => {
        document.getElementById('x-axis-dropzone').innerHTML = '<span class="dropzone-text">拖动指标到 X 轴</span>';
        document.getElementById('y-axis-dropzone').innerHTML = '<span class="dropzone-text">拖动一个或多个指标到 Y 轴</span>';

        if (chart) { chart.destroy(); chart = null; }
        document.getElementById('chart-container').innerHTML = `
            <div class="empty">
                <div class="empty-icon"><i class="ti ti-chart-line"></i></div>
                <p class="empty-title">请从左侧拖动维度到 X 轴和 Y 轴</p>
                <p class="empty-subtitle text-muted">将原材料或物性指标拖入上方框中，以生成关系图表。</p>
            </div>`;
    });

    function fetchChartData() {
        const xAxisItem = document.querySelector('#x-axis-dropzone .dimension-item');
        const yAxisItems = document.querySelectorAll('#y-axis-dropzone .dimension-item');

        if (!xAxisItem || yAxisItems.length === 0) {
            return;
        }

        const yAxes = Array.from(yAxisItems).map(item => ({
            type: item.dataset.type,
            id: item.dataset.id
        }));

        const params = new URLSearchParams({
            x_axis_type: xAxisItem.dataset.type,
            x_axis_id: xAxisItem.dataset.id,
            y_axes: JSON.stringify(yAxes)
        });

        document.getElementById('chart-container').innerHTML = '<div class="progress"><div class="progress-bar-indeterminate"></div></div>';

        fetch(`{% url 'formula_chart_data_api' %}?${params.toString()}`)
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    document.getElementById('chart-container').innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
                    return;
                }
                if (data.series && data.series.every(s => s.data.length === 0)) {
                     document.getElementById('chart-container').innerHTML = `
                        <div class="empty">
                            <div class="empty-icon"><i class="ti ti-chart-off"></i></div>
                            <p class="empty-title">没有足够的数据来生成图表</p>
                            <p class="empty-subtitle text-muted">请确保所选配方同时包含您选择的 X 轴和 Y 轴数据。</p>
                        </div>`;
                    return;
                }
                renderChart(data);
            })
            .catch(error => {
                console.error('Error fetching chart data:', error);
                document.getElementById('chart-container').innerHTML = `<div class="alert alert-danger">加载图表数据时出错。</div>`;
            });
    }

    function renderChart(data) {
        data.series.forEach(series => {
            if (series.data) {
                series.data.sort((a, b) => a.x - b.x);
            }
        });

        const chartOptions = {
            chart: { zoomType: 'xy' },
            title: { text: null },
            xAxis: {
                ...data.xAxis,
                title: { ...data.xAxis.title, style: {  } },
                labels: { style: {  } }
            },
            yAxis: data.yAxis,
            tooltip: {
                shared: true,
                crosshairs: true,
                headerFormat: '<b>{point.key}</b> (配方: {point.point.name})<br/>',
                pointFormat: '<span style="color:{series.color}">{series.name}</span>: <b>{point.y}</b><br/>'
            },
            series: data.series,
            credits: { enabled: false },
            plotOptions: {
                spline: {
                    marker: { enabled: true, radius: 4 },
                    dataLabels: { enabled: true, format: '{point.y}', style: { fontSize: '12px', color: '#000000', textOutline: 'none' } }
                }
            }
        };

        chart = Highcharts.chart('chart-container', chartOptions, function(c) {
            c.series.forEach((series, i) => {
                if (c.yAxis[i]) {
                    const seriesColor = series.color;
                    c.yAxis[i].update({
                        title: { style: { color: seriesColor } },
                        labels: { style: { color: seriesColor } }
                    });
                }
            });
        });
    }
});
</script>
{% endblock %}
