{% extends "base.html" %}

{% block content %}
    <div class="page-header d-print-none mb-3">
        <div class="row align-items-center">
            <div class="col">
                <div class="page-pretitle">原材料详情</div>
                <h2 class="page-title">{{ material.name }} {% if material.model_name %}{{ material.model_name }}{% endif %}</h2>
            </div>
            <div class="col-auto ms-auto">
                <a href="{% url 'raw_material_edit' material.pk %}" class="btn btn-primary">
                    <i class="ti ti-edit me-1"></i> 编辑
                </a>
            </div>
        </div>
    </div>

    <div class="row row-cards">
        <!-- 左侧：基础信息与文档 (30%) -->
        <div class="col-lg-4">
            
            <!-- 1. 基础信息卡片 -->
            <div class="card mb-3">
                <div class="card-header bg-blue-lt">
                    <h3 class="card-title text-blue"><i class="ti ti-info-circle me-2"></i>基础信息</h3>
                </div>
                <div class="card-body">
                    <dl class="row mb-0">
                        <dt class="col-5 text-muted">类型</dt>
                        <dd class="col-7"><span class="badge bg-blue-lt">{{ material.category.name }}</span></dd>
                        
                        <dt class="col-5 text-muted">供应商</dt>
                        <dd class="col-7">{{ material.supplier.name|default:"-" }}</dd>
                        
                        <dt class="col-5 text-muted">内部编码</dt>
                        <dd class="col-7">{{ material.warehouse_code|default:"-" }}</dd>
                        
                        <dt class="col-5 text-muted">购入日期</dt>
                        <dd class="col-7">{{ material.purchase_date|date:"Y-m-d"|default:"-" }}</dd>
                        
                        <dt class="col-5 text-muted">适用体系</dt>
                        <dd class="col-7">
                            {% for mat_type in material.suitable_materials.all %}
                                <span class="badge bg-green-lt mb-1">{{ mat_type.name }}</span>
                            {% empty %}
                                <span class="text-muted">-</span>
                            {% endfor %}
                        </dd>
                    </dl>
                </div>
            </div>
            
            <!-- 2. 成本信息 (新增) -->
            <div class="card mb-3">
                <div class="card-header bg-green-lt">
                    <h3 class="card-title text-green"><i class="ti ti-currency-yen me-2"></i>成本信息</h3>
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <span class="text-muted">参考成本</span>
                        <span class="h2 mb-0 text-orange">
                            {% if material.cost_price %}¥{{ material.cost_price }}{% else %}-{% endif %}
                            <span class="fs-5 text-muted fw-normal">/kg</span>
                        </span>
                    </div>
                </div>
            </div>
            
            <!-- 3. 文档下载 -->
            <div class="card mb-3">
                <div class="card-header bg-red-lt">
                    <h3 class="card-title text-red"><i class="ti ti-file-download me-2"></i>文档资料</h3>
                </div>
                <div class="list-group list-group-flush">
                    {% if material.file_tds %}
                        <a href="{% url 'secure_download' 'app_raw_material' 'rawmaterial' material.pk 'file_tds' %}" target="_blank" class="list-group-item list-group-item-action d-flex align-items-center">
                            <span class="avatar avatar-xs bg-azure-lt me-2">TDS</span>
                            TDS 物性表
                            <i class="ti ti-download ms-auto text-muted"></i>
                        </a>
                    {% endif %}
                    {% if material.file_msds %}
                        <a href="{% url 'secure_download' 'app_raw_material' 'rawmaterial' material.pk 'file_msds' %}" target="_blank" class="list-group-item list-group-item-action d-flex align-items-center">
                            <span class="avatar avatar-xs bg-red-lt me-2">MSDS</span>
                            MSDS 报告
                            <i class="ti ti-download ms-auto text-muted"></i>
                        </a>
                    {% endif %}
                    {% if material.file_rohs %}
                        <a href="{% url 'secure_download' 'app_raw_material' 'rawmaterial' material.pk 'file_rohs' %}" target="_blank" class="list-group-item list-group-item-action d-flex align-items-center">
                            <span class="avatar avatar-xs bg-green-lt me-2">RoHS</span>
                            RoHS 环保报告
                            <i class="ti ti-download ms-auto text-muted"></i>
                        </a>
                    {% endif %}
                    {% if not material.file_tds and not material.file_msds and not material.file_rohs %}
                        <div class="list-group-item text-muted text-center py-3">
                            <i class="ti ti-file-off fs-2 d-block mb-2 opacity-25"></i>
                            暂无文档
                        </div>
                    {% endif %}
                </div>
            </div>
            
            <!-- 4. 使用说明 -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title"><i class="ti ti-notes me-2"></i>使用说明</h3>
                </div>
                <div class="card-body">
                    {{ material.usage_method|linebreaks|default:"暂无描述" }}
                </div>
            </div>
        </div>
        
        <!-- 右侧：性能指标 (70%) -->
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header bg-purple-lt">
                    <h3 class="card-title text-purple"><i class="ti ti-flask me-2"></i>性能指标</h3>
                </div>
                <div class="table-responsive">
                    <table class="table table-vcenter card-table table-striped">
                        <thead>
                        <tr>
                            <th>分类</th>
                            <th>测试项目</th>
                            <th>标准/条件</th>
                            <th>数值 / 结果</th>
                            <th>测试日期</th>
                            <th>备注</th>
                        </tr>
                        </thead>
                        <tbody>
                        {% for prop in material.properties.all %}
                            <tr>
                                <td><span class="badge bg-secondary-lt">{{ prop.test_config.category.name }}</span></td>
                                <td class="fw-bold">{{ prop.test_config.name }}</td>
                                <td class="text-muted small">
                                    {{ prop.test_config.standard }}
                                    {% if prop.test_config.condition %}<br>({{ prop.test_config.condition }}){% endif %}
                                </td>
                                <td class="fs-3 fw-bold text-dark">
                                    {% if prop.test_config.data_type == 'NUMBER' %}
                                        {{ prop.value }}
                                    {% else %}
                                        <!-- 文本或选择类型，显示 value_text -->
                                        {{ prop.value_text }}
                                    {% endif %}
                                    <span class="text-muted fs-5 fw-normal">{{ prop.test_config.unit }}</span>
                                </td>
                                <td>{{ prop.test_date|date:"Y-m-d"|default:"-" }}</td>
                                <td class="text-muted">{{ prop.remark }}</td>
                            </tr>
                        {% empty %}
                            <tr>
                                <td colspan="6" class="text-center py-5 text-muted">
                                    <i class="ti ti-flask-off fs-1 d-block mb-2 opacity-25"></i>
                                    暂无性能数据
                                </td>
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
{% endblock %}