{% extends "base.html" %}

{% block content %}
    <div class="page-header d-print-none">
        <div class="row align-items-center">
            <div class="col">
                <div class="page-pretitle">{% if is_edit %}Edit Material{% else %}New Material{% endif %}</div>
                <h2 class="page-title">{{ page_title }}</h2>
            </div>
        </div>
    </div>

    <!-- enctype="multipart/form-data" 必须要有，才能上传文件 -->
    <form method="post" enctype="multipart/form-data" class="mt-3">
        {% csrf_token %}

        <!-- 全局错误提示 -->
        {% if form.non_field_errors %}
            <div class="alert alert-danger" role="alert">
                {{ form.non_field_errors }}
            </div>
        {% endif %}

        <!-- ============================================================ -->
        <!-- 板块 1：核心身份信息 (Card) - 保持不变 -->
        <!-- ============================================================ -->
        {% include 'apps/app_repository/material/form_card/form_info.html' %}

        <!-- ============================================================ -->
        <!-- 【核心修改】板块 2：性能数据录入 (动态 FormSet) -->
        <!-- ============================================================ -->
        {% include 'apps/app_repository/material/form_card/form_data.html' %}


        <div class="row row-deck row-cards mt-3">
            <div class="col-lg-6">
                <!-- ============================================================ -->
                <!-- 板块 3：文件上传 (TDS/MSDS/RoHS) - 保持不变 -->
                <!-- ============================================================ -->
                {% include 'apps/app_repository/material/form_card/form_file.html' %}
            </div>
            <div class="col-lg-6">
                <!-- ============================================================ -->
                <!-- 板块 4：详细特性描述 (原 板块 3) -->
                <!-- ============================================================ -->
                {% include 'apps/app_repository/material/form_card/form_description.html' %}
            </div>
        </div>


    </form>


    <!-- ============================================================ -->
    <!-- 隐藏的空表单模板 (用于 JS 动态添加行) -->
    <!-- 必须放在 table 之外，且 style="display:none" -->
    <!-- ============================================================ -->
    <template id="empty-form-template">
        <tr class="form-row">
            <!-- 渲染隐藏字段 (如 ID) -->
            {% for hidden in data_formset.empty_form.hidden_fields %}
                {{ hidden }}
            {% endfor %}

            <!-- 1. 测试配置项 (下拉框) -->
            <td>
                {{ data_formset.empty_form.test_config }}
                {% if data_formset.empty_form.test_config.errors %}
                    <div class="text-danger small">{{ data_formset.empty_form.test_config.errors.0 }}</div>
                {% endif %}
            </td>

            <!-- 2. 数值/文本/选择 -->
            <td>
                {{ data_formset.empty_form.value }}
                {{ data_formset.empty_form.value_text }}
                {{ data_formset.empty_form.value_select }}
                {% if data_formset.empty_form.value.errors %}
                    <div class="text-danger small">{{ data_formset.empty_form.value.errors.0 }}</div>
                {% endif %}
            </td>

            <!-- 3. 备注 -->
            <td>
                {{ data_formset.empty_form.remark }}
            </td>

            <!-- 4. 删除按钮 (动态添加的行用 JS 移除即可) -->
            <td>
                <button type="button" class="btn btn-icon btn-ghost-danger btn-sm remove-row" title="移除此行">
                    <i class="ti ti-trash"></i>
                </button>
            </td>
        </tr>
    </template>
    <!-- Tom Select 集成 -->
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            if (window.TomSelect) {
                // --- 1. 初始化远程搜索的 Tom Select (单选) ---
                // 适用于 ProjectRepositoryForm 中的 customer, oem, material, salesperson
                // 以及 RawMaterialForm 中的 supplier
                document.querySelectorAll('.remote-search:not(.tomselect-multi-remote)').forEach(function (el) {
                    var modelType = el.getAttribute('data-model');
                    new TomSelect(el, {
                        valueField: 'value',
                        labelField: 'text',
                        searchField: 'text',
                        load: function (query, callback) {
                            var url = "{% url 'repo_api_search' %}?model=" + modelType + "&q=" + encodeURIComponent(query);
                            fetch(url)
                                .then(response => response.json())
                                .then(json => {
                                    callback(json);
                                })
                                .catch(() => {
                                    callback();
                                });
                        },
                        copyClassesToDropdown: false,
                        dropdownParent: 'body',
                        create: false,
                        placeholder: '请输入关键词搜索...',
                        preload: 'focus',
                        render: {
                            option: function (data, escape) {
                                return '<div>' + escape(data.text) + '</div>';
                            },
                            item: function (data, escape) {
                                return '<div>' + escape(data.text) + '</div>';
                            },
                            no_results: function (data, escape) {
                                return '<div class="no-results p-2 text-muted small">无匹配结果</div>';
                            },
                            loading: function (data, escape) {
                                return '<div class="spinner-border spinner-border-sm text-muted m-2"></div>';
                            }
                        }
                    });
                });

                // --- 2. 初始化远程搜索的 Tom Select (多选，胶囊样式) ---
                // 适用于 MaterialForm 中的 scenarios
                document.querySelectorAll('.remote-search.tomselect-multi-remote').forEach(function (el) {
                    var modelType = el.getAttribute('data-model');
                    new TomSelect(el, {
                        mode: 'multi', // 启用多选模式
                        valueField: 'value',
                        labelField: 'text',
                        searchField: 'text',
                        load: function (query, callback) {
                            var url = "{% url 'repo_api_search' %}?model=" + modelType + "&q=" + encodeURIComponent(query);
                            fetch(url)
                                .then(response => response.json())
                                .then(json => {
                                    callback(json);
                                })
                                .catch(() => {
                                    callback();
                                });
                        },
                        copyClassesToDropdown: false,
                        dropdownParent: 'body',
                        create: false,
                        placeholder: '请输入关键词搜索...',
                        preload: 'focus',
                        plugins: ['remove_button'], // 允许移除已选中的项
                        render: {
                            option: function (data, escape) {
                                return '<div>' + escape(data.text) + '</div>';
                            },
                            item: function (data, escape) {
                                return '<div>' + escape(data.text) + '</div>';
                            },
                            no_results: function (data, escape) {
                                return '<div class="no-results p-2 text-muted small">无匹配结果</div>';
                            },
                            loading: function (data, escape) {
                                return '<div class="spinner-border spinner-border-sm text-muted m-2"></div>';
                            }
                        }
                    });
                });

                // --- 3. 初始化本地多选的 Tom Select (胶囊样式) ---
                // 适用于 ProcessProfileForm 中的 material_types
                document.querySelectorAll('.tomselect-multi-local').forEach(function (el) {
                    new TomSelect(el, {
                        mode: 'multi', // 启用多选模式
                        copyClassesToDropdown: false,
                        dropdownParent: 'body',
                        create: false,
                        placeholder: '请选择...',
                        plugins: ['remove_button'], // 允许移除已选中的项
                        render: {
                            option: function (data, escape) {
                                return '<div>' + escape(data.text) + '</div>';
                            },
                            item: function (data, escape) {
                                return '<div>' + escape(data.text) + '</div>';
                            },
                            no_results: function (data, escape) {
                                return '<div class="no-results p-2 text-muted small">无匹配结果</div>';
                            }
                        }
                    });
                });

                // --- 4. 初始化 FormSet 内部的 Tom Select (本地搜索，单选) ---
                // 适用于 MaterialDataPointForm 中的 test_config
                function initFormsetTomSelect(element) {
                    if (window.TomSelect && !element.classList.contains('tomselected')) {
                        new TomSelect(element, {
                            copyClassesToDropdown: false,
                            dropdownParent: 'body',
                            controlInput: '<input>',
                            create: false,
                            placeholder: '点击搜索...',
                            plugins: ['remove_button', 'clear_button'],
                            render: {
                                no_results: function (data, escape) {
                                    return '<div class="no-results p-2 text-muted small">无匹配结果</div>';
                                }
                            },
                            onChange: function(value) {
                                if (typeof toggleValueInput === 'function') {
                                    toggleValueInput(element);
                                }
                            }
                        });
                    }
                }
                document.querySelectorAll('.form-select-search').forEach(initFormsetTomSelect);
            }

            // --- FormSet 动态添加行逻辑 ---
            const addBtn = document.getElementById('add-row');
            const tableBody = document.querySelector('#data-table tbody');
            const totalFormsInput = document.getElementById('id_properties-TOTAL_FORMS'); // 假设是 properties

            if (addBtn && tableBody && totalFormsInput) {
                addBtn.addEventListener('click', function () {
                    let formIdx = parseInt(totalFormsInput.value);
                    const template = document.getElementById('empty-form-template');
                    if (!template) {
                        console.error("找不到 ID 为 empty-form-template 的模板，请检查 HTML");
                        return;
                    }
                    let newRowHtml = template.innerHTML.replace(/__prefix__/g, formIdx);
                    let newRow = document.createElement('tr');
                    newRow.className = 'form-row';
                    newRow.innerHTML = newRowHtml;
                    tableBody.appendChild(newRow);
                    totalFormsInput.value = formIdx + 1;
                    
                    // 【关键】给新行里的下拉框应用 Tom Select
                    newRow.querySelectorAll('.form-select-search').forEach(initFormsetTomSelect);
                });
            } else {
                console.error("无法找到表格或添加按钮，请检查 HTML ID 是否匹配");
            }

            // --- 动态删除行逻辑 (事件委托) ---
            tableBody.addEventListener('click', function (e) {
                const btn = e.target.closest('.remove-row');
                if (btn) {
                    const row = btn.closest('tr');
                    row.remove();
                }
            });
        });
    </script>
{% endblock %}