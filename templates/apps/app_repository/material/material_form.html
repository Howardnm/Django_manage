{% extends "base.html" %}

{% block content %}
    <div class="page-header d-print-none">
        <div class="row align-items-center">
            <div class="col">
                <div class="page-pretitle">{% if is_edit %}Edit Material{% else %}New Material{% endif %}</div>
                <h2 class="page-title">{{ page_title }}</h2>
            </div>
        </div>
    </div>

    <!-- enctype="multipart/form-data" 必须要有，才能上传文件 -->
    <form method="post" enctype="multipart/form-data" class="mt-3">
        {% csrf_token %}

        <!-- 全局错误提示 -->
        {% if form.non_field_errors %}
            <div class="alert alert-danger" role="alert">
                {{ form.non_field_errors }}
            </div>
        {% endif %}

        <!-- ============================================================ -->
        <!-- 板块 1：核心身份信息 (Card) - 保持不变 -->
        <!-- ============================================================ -->
        {% include 'apps/app_repository/material/form_card/form_info.html' %}

        <!-- ============================================================ -->
        <!-- 【核心修改】板块 2：性能数据录入 (动态 FormSet) -->
        <!-- ============================================================ -->
        {% include 'apps/app_repository/material/form_card/form_data.html' %}


        <div class="row row-deck row-cards mt-3">
            <div class="col-lg-6">
                <!-- ============================================================ -->
                <!-- 板块 3：文件上传 (TDS/MSDS/RoHS) - 保持不变 -->
                <!-- ============================================================ -->
                {% include 'apps/app_repository/material/form_card/form_file.html' %}
            </div>
            <div class="col-lg-6">
                <!-- ============================================================ -->
                <!-- 板块 4：详细特性描述 (原 板块 3) -->
                <!-- ============================================================ -->
                {% include 'apps/app_repository/material/form_card/form_description.html' %}
            </div>
        </div>


    </form>


    <!-- ============================================================ -->
    <!-- 隐藏的空表单模板 (用于 JS 动态添加行) -->
    <!-- 必须放在 table 之外，且 style="display:none" -->
    <!-- ============================================================ -->
    <template id="empty-form-template">
        <tr class="form-row">
            <!-- 渲染隐藏字段 (如 ID) -->
            {% for hidden in data_formset.empty_form.hidden_fields %}
                {{ hidden }}
            {% endfor %}

            <!-- 1. 测试配置项 (下拉框) -->
            <td>
                {{ data_formset.empty_form.test_config }}
                {% if data_formset.empty_form.test_config.errors %}
                    <div class="text-danger small">{{ data_formset.empty_form.test_config.errors.0 }}</div>
                {% endif %}
            </td>

            <!-- 2. 数值/文本/选择 -->
            <td>
                {{ data_formset.empty_form.value }}
                {{ data_formset.empty_form.value_text }}
                {{ data_formset.empty_form.value_select }}
                {% if data_formset.empty_form.value.errors %}
                    <div class="text-danger small">{{ data_formset.empty_form.value.errors.0 }}</div>
                {% endif %}
            </td>

            <!-- 3. 备注 -->
            <td>
                {{ data_formset.empty_form.remark }}
            </td>

            <!-- 4. 删除按钮 (动态添加的行用 JS 移除即可) -->
            <td>
                <button type="button" class="btn btn-icon btn-ghost-danger btn-sm remove-row" title="移除此行">
                    <i class="ti ti-trash"></i>
                </button>
            </td>
        </tr>
    </template>
    <!-- Tom Select 集成 (移到这里确保 FormSet 字段也能被处理) -->
    <script>
        document.addEventListener("DOMContentLoaded", function () {

            // --- 1. Tom Select 初始化函数 (封装以便复用) ---
            function initTomSelect(element) {
                // 防止重复初始化
                if (window.TomSelect && !element.classList.contains('tomselected')) {
                    new TomSelect(element, {
                        copyClassesToDropdown: false,
                        dropdownParent: 'body',
                        controlInput: '<input>',
                        create: false,
                        placeholder: '点击搜索...',
                        plugins: ['remove_button', 'clear_button'],
                        render: {
                            no_results: function (data, escape) {
                                return '<div class="no-results p-2 text-muted small">无匹配结果</div>';
                            }
                        },
                        // 监听变化，触发 toggleValueInput
                        onChange: function(value) {
                            // 找到原始的 select 元素并触发 onchange 事件
                            // 因为 Tom Select 会隐藏原始 select，但我们逻辑绑定在原始 select 上
                            // 或者直接在这里调用逻辑
                            // 注意：element 是原始 select
                            if (typeof toggleValueInput === 'function') {
                                toggleValueInput(element);
                            }
                        }
                    });
                }
            }

            // --- 2. 页面加载时：初始化现有的下拉框 ---
            document.querySelectorAll('.form-select-search').forEach(initTomSelect);

            // --- 3. 动态添加行逻辑 ---
            const addBtn = document.getElementById('add-row');
            const tableBody = document.querySelector('#data-table tbody');
            // 注意：Django inlineformset_factory 默认的前缀通常是 related_name (properties)
            // 如果这里报错，请 F12 查看页面上的 hidden input id 是什么，通常是 id_properties-TOTAL_FORMS
            const totalFormsInput = document.getElementById('id_properties-TOTAL_FORMS');

            if (addBtn && tableBody && totalFormsInput) {
                addBtn.addEventListener('click', function () {
                    // A. 获取当前表单总数
                    let formIdx = parseInt(totalFormsInput.value);

                    // B. 获取模板内容
                    const template = document.getElementById('empty-form-template');
                    if (!template) {
                        console.error("找不到 ID 为 empty-form-template 的模板，请检查 HTML");
                        return;
                    }

                    // C. 克隆并替换 ID (核心步骤: __prefix__ -> 0, 1, 2...)
                    let newRowHtml = template.innerHTML.replace(/__prefix__/g, formIdx);

                    // D. 创建 TR 元素并插入
                    let newRow = document.createElement('tr');
                    newRow.className = 'form-row'; // 保持样式一致
                    newRow.innerHTML = newRowHtml;
                    tableBody.appendChild(newRow);

                    // E. 更新 Django 管理表单计数器
                    totalFormsInput.value = formIdx + 1;

                    // F. 【关键】给新行里的下拉框应用 Tom Select
                    newRow.querySelectorAll('.form-select-search').forEach(initTomSelect);
                });
            } else {
                console.error("无法找到表格或添加按钮，请检查 HTML ID 是否匹配");
            }

            // --- 4. 动态删除行逻辑 (事件委托) ---
            tableBody.addEventListener('click', function (e) {
                // 查找点击的是否是删除按钮 (包含子元素图标)
                const btn = e.target.closest('.remove-row');
                if (btn) {
                    const row = btn.closest('tr');
                    // 直接移除 DOM 元素 (注意：这只适用于新建的行。如果是已保存的行，逻辑不同，这里模板里已经处理了区分)
                    row.remove();
                    // 注意：这里不需要减少 TOTAL_FORMS，Django 会处理空缺
                }
            });
        });
    </script>
{% endblock %}